var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);i.prototype=e.prototype,t.prototype=new i},__awaiter=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(s,r){function a(t){try{h(n.next(t))}catch(e){r(e)}}function o(t){try{h(n["throw"](t))}catch(e){r(e)}}function h(t){t.done?s(t.value):new i(function(e){e(t.value)}).then(a,o)}h((n=n.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function i(t){return function(e){return n([t,e])}}function n(i){if(s)throw new TypeError("Generator is already executing.");for(;h;)try{if(s=1,r&&(a=r[2&i[0]?"return":i[0]?"throw":"next"])&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[0,a.value]),i[0]){case 0:case 1:a=i;break;case 4:return h.label++,{value:i[1],done:!1};case 5:h.label++,r=i[1],i=[0];continue;case 7:i=h.ops.pop(),h.trys.pop();continue;default:if(a=h.trys,!(a=a.length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){h=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){h.label=i[1];break}if(6===i[0]&&h.label<a[1]){h.label=a[1],a=i;break}if(a&&h.label<a[2]){h.label=a[2],h.ops.push(i);break}a[2]&&h.ops.pop(),h.trys.pop();continue}i=e.call(t,h)}catch(n){i=[6,n],r=0}finally{s=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var s,r,a,o,h={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:i(0),"throw":i(1),"return":i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o},Main=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.createChildren=function(){t.prototype.createChildren.call(this),egret.lifecycle.addLifecycleListener(function(t){}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()};var e=new AssetAdapter;egret.registerImplementation("eui.IAssetAdapter",e),egret.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.runGame()["catch"](function(t){console.log(t)})},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.loadResource()];case 1:return t.sent(),this.createGameScene(),[2]}})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return i.trys.push([0,4,,5]),t=new LoadingUI,this.stage.addChild(t),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return i.sent(),[4,this.loadTheme()];case 2:return i.sent(),[4,RES.loadGroup("preload",0,t)];case 3:return i.sent(),this.stage.removeChild(t),[3,5];case 4:return e=i.sent(),console.error(e),[3,5];case 5:return[2]}})})},e.prototype.loadTheme=function(){var t=this;return new Promise(function(e,i){var n=new eui.Theme("resource/default.thm.json",t.stage);n.addEventListener(eui.UIEvent.COMPLETE,function(){e()},t)})},e.prototype.createGameScene=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){return t=new GameView,this.addChild(t),[2]})})},e}(eui.UILayer);__reflect(Main.prototype,"Main");var AssetAdapter=function(){function t(){}return t.prototype.getAsset=function(t,e,i){function n(n){e.call(i,n,t)}if(RES.hasRes(t)){var s=RES.getRes(t);s?n(s):RES.getResAsync(t,n,this)}else RES.getResByUrl(t,n,this,RES.ResourceItem.TYPE_IMAGE)},t}();__reflect(AssetAdapter.prototype,"AssetAdapter",["eui.IAssetAdapter"]);var DrawUtils=function(){function t(){this.lineWidth=2,this.color=16716947}return Object.defineProperty(t,"instance",{get:function(){return null==t._instance&&(t._instance=new t),t._instance},enumerable:!0,configurable:!0}),t.prototype.toTuple=function(t){var e=t.y,i=t.x;return[e,i]},t.prototype.drawPoint=function(t,e,i,n,s){t.beginPath(),t.arc(i,e,n,0,2*Math.PI),t.fillStyle=s.toString(),t.fill()},t.prototype.drawSegment=function(t,e,i,n,s){s.beginPath(),s.moveTo(t[1]*n,t[0]*n),s.lineTo(e[1]*n,e[0]*n),s.lineWidth=this.lineWidth,s.strokeStyle=i.toString(),s.stroke()},t.prototype.drawSkeleton=function(t,e,i,n){var s=this;void 0===n&&(n=1);var r=posenet.getAdjacentKeyPoints(t,e);r.forEach(function(t){s.drawSegment(s.toTuple(t[0].position),s.toTuple(t[1].position),s.color,n,i)})},t.prototype.drawKeypoints=function(t,e,i,n){void 0===n&&(n=1);for(var s=0;s<t.length;s++){var r=t[s];if(!(r.score<e)){var a=r.position,o=a.y,h=a.x;this.drawPoint(i,o*n,h*n,30,this.color)}}},t.prototype.drawBoundingBox=function(t,e){var i=posenet.getBoundingBox(t);e.rect(i.minX,i.minY,i.maxX-i.minX,i.maxY-i.minY),e.stroke()},t.prototype.shapeDrawKeypoints=function(t,e,i,n){void 0===n&&(n=1);for(var s=0;s<t.length;s++){var r=t[s];if(!(r.score<e)){var a=r.position,o=a.y,h=a.x;this.shapeDrawPoint(i,o*n,h*n,10*n,this.color)}}},t.prototype.shapeDrawPoint=function(t,e,i,n,s){if(i>=0&&i<=t.width&&e>=0&&e<=t.height){var r=t.graphics;r.beginFill(s),r.drawCircle(i,e,n),r.endFill()}},t.prototype.shapeDrawSkeleton=function(t,e,i,n){var s=this;void 0===n&&(n=1);var r=posenet.getAdjacentKeyPoints(t,e);r.forEach(function(t){s.shapeDrawSegment(s.toTuple(t[0].position),s.toTuple(t[1].position),s.color,n,i)})},t.prototype.shapeDrawSegment=function(t,e,i,n,s){var r=t[0],a=t[1],o=e[0],h=e[1];if(r>=0&&r<=s.width&&o>=0&&o<=s.width&&a>=0&&a<=s.height&&h>=0&&h<=s.height){var c=s.graphics;c.lineStyle(this.lineWidth*n,i),c.moveTo(t[1]*n,t[0]*n),c.lineTo(e[1]*n,e[0]*n)}},t.prototype.renderToCanvas=function(t,e){return __awaiter(this,void 0,void 0,function(){var i,n,s,r,a,o,h,c;return __generator(this,function(l){switch(l.label){case 0:return i=t.shape,n=i[0],s=i[1],r=new ImageData(s,n),[4,t.data()];case 1:for(a=l.sent(),o=0;n*s>o;++o)h=4*o,c=3*o,r.data[h+0]=a[c+0],r.data[h+1]=a[c+1],r.data[h+2]=a[c+2],r.data[h+3]=255;return e.putImageData(r,0,0),[2]}})})},t.prototype.renderImageToCanvas=function(t,e,i){i.width=e[0],i.height=e[1];var n=i.getContext("2d");n.drawImage(t,0,0)},t.prototype.drawHeatMapValues=function(t,e,i){var n=i.getContext("2d"),s=5,r=t.mul(tf.scalar(e,"int32"));this.drawPoints(n,r,s,this.color)},t.prototype.drawPoints=function(t,e,i,n){for(var s=e.buffer().values,r=0;r<s.length;r+=2){var a=s[r],o=s[r+1];0!==o&&0!==a&&(t.beginPath(),t.arc(o,a,i,0,2*Math.PI),t.fillStyle=n.toString(),t.fill())}},t.prototype.drawOffsetVectors=function(t,e,i,n,s){void 0===n&&(n=1);for(var r=posenet.singlePose.getOffsetPoints(t,i,e),a=t.buffer().values,o=r.buffer().values,h=0;h<a.length;h+=2){var c=a[h]*i,l=a[h+1]*i,u=o[h],p=o[h+1];this.drawSegment([c,l],[u,p],this.color,n,s)}},t}();__reflect(DrawUtils.prototype,"DrawUtils");var GameView=function(t){function e(){var e=t.call(this)||this;return e.bgMask=new egret.Shape,e.skinName="GameV",e.addEventListener(egret.Event.ADDED_TO_STAGE,e.start,e),e}return __extends(e,t),e.prototype.start=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,PoseUtils.instance.loadModel()];case 1:return t.sent(),[4,this.setUpCamera()];case 2:return t.sent(),[4,this.initData()];case 3:return t.sent(),this.initView(),this.addEvent(),this.draw(),this.stateChange(),[2]}})})},e.prototype.setUpCamera=function(){return __awaiter(this,void 0,void 0,function(){var t,e=this;return __generator(this,function(i){switch(i.label){case 0:return this.webcam=document.getElementById("video"),[4,navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"user"}})];case 1:return t=i.sent(),this.webcam.srcObject=t,[2,new Promise(function(t){e.webcam.onloadedmetadata=function(){t(e.webcam)}})]}})})},e.prototype.initView=function(){var t=document.getElementsByTagName("canvas")[0],e=document.createElement("canvas");t.parentElement.appendChild(e);var i=t.style,n=e.style;i.zIndex="2",n.zIndex="1",e.width=t.width,e.height=t.height,n.position="absolute",n.transformOrigin=i.transformOrigin,n.transform=i.transform,n.left=i.left,n.top=i.top,this.canvas=e,this.ctx=e.getContext("2d"),this.ctx.scale(-1,1),this.ctx.translate(-this.canvas.width,0),this.bgMask=new egret.Shape,this.bgMask.graphics.beginFill(9662683),this.bgMask.graphics.drawRect(0,0,this.width,this.height),this.bgMask.graphics.endFill(),this.addChild(this.bgMask),this.setChildIndex(this.bgMask,0),this.bgMask.alpha=.2},e.prototype.initData=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return t=this.webcam.videoWidth/this.webcam.videoHeight,e=this.width/this.height,t>e?(this.webWidth=2*Math.floor(this.webcam.videoHeight*e/2),this.webHeight=this.webcam.videoHeight):(this.webWidth=this.webcam.videoWidth,this.webHeight=2*Math.floor(this.webcam.videoWidth/e/2)),this.curScore=this.bestScore=0,this.curLb.text=this.bestLb.text="0",this.selectClass=this.selectInd=-1,this.listExamples.itemRenderer=ExampleItemRenderer,this.knn=new KNNClassifier,[4,this.restoreFile()];case 1:return i.sent(),[2]}})})},e.prototype.addEvent=function(){this.gotoBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.stateChange,this),this.newGameInGameOver.addEventListener(egret.TouchEvent.TOUCH_TAP,this.newGame,this),this.restoreBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onBtnHandler,this),this.saveBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onBtnHandler,this),this.addBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onBtnHandler,this),this.delBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onBtnHandler,this),this.switchBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onBtnHandler,this),this.newGameInGameOver.touchEnabled=!0},e.prototype.restoreFile=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.knn.restoreFile()];case 1:return t.sent(),this.trainTypeSwitch(1),[2]}})})},e.prototype.onBtnHandler=function(t){switch(t.target){case this.restoreBtn:this.restoreFile();break;case this.saveBtn:this.knn.saveFile();break;case this.addBtn:this.testTime=4e3,this.testCount(2);break;case this.delBtn:if(this.listExamples.selectedIndex<0)break;1==this.trainType?this.knn.delExample(this.listExamples.selectedIndex):this.knn.delExample(this.selectClass,this.listExamples.selectedIndex),this.listExamples.dataProvider.removeItemAt(this.listExamples.selectedIndex);break;case this.switchBtn:if(1==this.trainType&&this.listExamples.selectedIndex<0)break;this.trainTypeSwitch(this.trainType%2+1)}},e.prototype.stateChange=function(t){void 0===t&&(t=null),this.testClass=-1,this.testPoints=null,this.testTime=-1,null==t||"trainState"==this.currentState?(TimerManager.instance.clearTimer(this.predictPose),this.currentState="testState",this.bgMask.alpha=.1,this.newGame()):(this.currentState="trainState",this.bgMask.alpha=.8,this.wantLb.text="管理您的舞动模型",this.trainTypeSwitch(1),TimerManager.instance.doLoop(1e3,this.predictPose,this,[3]))},e.prototype.trainTypeSwitch=function(t){if("trainState"==this.currentState){if(this.trainType=t,1==t){this.addBtn.label="增加姿势种类",this.delBtn.label="减少姿势种类",this.switchBtn.label="查看种类样本";var e=[];this.knn.classOriginDataset.forEach(function(t){e.push(t[0])}),this.listExamples.dataProvider=new eui.ArrayCollection(e)}else this.addBtn.label="增加姿势样本",this.delBtn.label="减少姿势样本",this.switchBtn.label="返回种类",this.selectClass=this.listExamples.selectedIndex,this.listExamples.dataProvider=new eui.ArrayCollection(this.knn.classOriginDataset[this.selectClass]);this.listExamples.selectedIndex=-1}},e.prototype.newGame=function(t){void 0===t&&(t=null),this.gameOver.visible=!1,this.curScore=0,this.curLb.text="0",this.knn.getNumExamples()<3?this.wantLb.text="请先对模型进行训练":(this.wantLb.text="按照指示完成屏幕上动作",this.newLevel())},e.prototype.newLevel=function(){TimerManager.instance.clearTimer(this.testCount);var t=this.knn.getRandExample();this.testClass=t.classId,this.testPoints=t.posepoints,this.testTime=5e3,this.predictPose(2),this.testCount(1)},e.prototype.testCount=function(t){this.testTime-=500,this.testTime<0?1==t?this.showGameOver():this.predictPose(1):(TimerManager.instance.doOnce(500,this.testCount,this,[t]),this.timeLb.text=Math.floor(this.testTime/1e3).toString(),1==t&&this.predictPose(2))},e.prototype.showGameOver=function(){this.gameOver.visible=!0},e.prototype.draw=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.ctx.drawImage(this.webcam,(this.webcam.videoWidth-this.webWidth)/2,(this.webcam.videoHeight-this.webHeight)/2,this.webWidth,this.webHeight,0,0,this.canvas.width,this.canvas.height),this.testPoints&&(DrawUtils.instance.drawSkeleton(this.testPoints,.1,this.ctx),DrawUtils.instance.drawKeypoints(this.testPoints,.1,this.ctx)),TimerManager.instance.doFrameOnce(1,this.draw,this),[2]})})},e.prototype.predictPose=function(t){return __awaiter(this,void 0,void 0,function(){var e,i;return __generator(this,function(n){switch(n.label){case 0:return 1==this.predictingType?[2,null]:3==this.predictingType?(this.predictingType=t,[2,null]):(this.predictingType=t,[4,PoseUtils.instance.estimateSinglePose(this.canvas)]);case 1:switch(e=n.sent(),t=this.predictingType,this.predictingType=-1,t){case 1:i=!1,1==this.trainType?(i=this.knn.addExample(e.keypoints),i&&this.listExamples.dataProvider.addItem(e.keypoints)):(i=this.knn.addExample(e.keypoints,this.selectClass),i&&this.listExamples.dataProvider.itemUpdated(e.keypoints));break;case 2:this.testTime>0&&this.testClass==this.knn.predictClass(e).classIndex&&(this.curScore+=10,this.curLb.text=this.curScore.toString(),this.curScore>this.bestScore&&(this.bestScore=this.curScore,this.bestLb.text=this.bestScore.toString()),this.newLevel());break;case 3:this.testPoints=e.keypoints}return[2]}})})},e}(eui.Component);__reflect(GameView.prototype,"GameView");var ExampleItemRenderer=function(t){function e(){var e=t.call(this)||this;return e.skinName="skins.components.ExampleItemSkin",e}return __extends(e,t),e.prototype.createChildren=function(){t.prototype.createChildren.call(this),this.shp=new egret.Shape,this.addChild(this.shp)},Object.defineProperty(e.prototype,"selected",{set:function(t){this.isSelect=t,this.dataChanged()},enumerable:!0,configurable:!0}),e.prototype.dataChanged=function(){if(this.data){var t=this.shp.graphics;t.clear(),this.isSelect?t.beginFill(0):t.beginFill(16777215),t.drawRect(0,0,this.width,this.height),t.endFill(),DrawUtils.instance.shapeDrawSkeleton(this.data,.01,this.shp,.1),DrawUtils.instance.shapeDrawKeypoints(this.data,.01,this.shp,.1)}},e}(eui.ItemRenderer);__reflect(ExampleItemRenderer.prototype,"ExampleItemRenderer");var KNNClassifier=function(){function t(){this.targetPartInd=[[5,7],[7,9],[6,8],[8,10],[11,13],[13,15],[12,14],[14,16]]}return t.prototype.addExample=function(t,e){void 0===e&&(e=-1);var i=this.tsfToVec(t);return null==i?!1:(0>e&&(e=this.classOriginDataset.length,this.classOriginDataset.push([]),this.classDataset.push([])),this.classOriginDataset[e].push(t),this.classDataset[e].push(i),!0)},t.prototype.tsfToVec=function(t,e){void 0===e&&(e=.1);for(var i=[],n=0,s=0;s<this.targetPartInd.length;s++){var r=t[this.targetPartInd[s][0]],a=t[this.targetPartInd[s][1]];r.score<e||a.score<e?(i.push(0),n++):i.push(Math.atan2(a.position.y-r.position.y,a.position.x-r.position.x))}return n>=10?null:i},t.prototype.getElidDistance=function(t){if(0==this.classDataset.length)throw new Error("Cannot predict without providing training examples.");for(var e=[],i=0;i<this.classDataset.length;i++){e[i]=[];for(var n=0;n<this.classDataset[i].length;n++){for(var s=this.classDataset[i][n],r=this.tsfToVec(t.keypoints),a=0,o=0;o<s.length;o++)a+=(s[o]-r[o]+2*Math.PI)%Math.PI;e.push(a)}}return e},t.prototype.predictClass=function(t,e){if(void 0===e&&(e=3),0==this.getNumExamples())throw new Error("You have not added any exaples to the KNN classifier. Please add examples before calling predictClass.");var i=this.getElidDistance(t),n=Math.min(e,this.getNumExamples()),s=this.topK(i,n);return this.calculateTopClass(s,n)},t.prototype.topK=function(t,e){for(var i=[],n=0;n<t.length;n++)i.push({value:t[n],index:n});i.sort(function(t,e){return e.value-t.value});for(var s=new Array(e),n=0;e>n;n++)s[n]=i[n].index;return s},t.prototype.delExample=function(t,e){void 0===e&&(e=-1),0>e?this.classDataset.splice(t,t+1):this.classDataset[t].splice(e,e+1)},t.prototype.calculateTopClass=function(t,e){for(var i=-1,n=[],s=0;s<this.classDataset.length;s++){var r=this.classDataset[s].length;s>0&&(r+=n[s-1]),n.push(r)}for(var a={},s=0;s<t.length;s++)for(var o=0;o<n.length;o++)if(t[s]<n[o]){o in a?a[o]++:a[o]=1;break}var h=0;for(var c in a){var l=a[c]/e;l>h&&(h=l,i=+c)}return{classIndex:i,confidence:h}},t.prototype.getRandExample=function(){var t=this.getNumExamples(),e=Math.floor(Math.random()*t);return{classId:e,posepoints:this.classOriginDataset[e][0]}},t.prototype.getNumExamples=function(){return this.classDataset.length},t.prototype.saveFile=function(t){void 0===t&&(t="knn_model");var e=new File([JSON.stringify(this.classOriginDataset)],t+".json",{type:"json"});saveAs(e)},t.prototype.restoreFile=function(t){return void 0===t&&(t="knn_model_json"),__awaiter(this,void 0,void 0,function(){var e,i,n,s,r;return __generator(this,function(a){switch(a.label){case 0:return e=this,[4,RES.getRes(t)];case 1:for(e.classOriginDataset=a.sent(),this.classDataset=[],i=0;i<this.classOriginDataset.length;i++)for(this.classDataset[i]=[],n=this.classOriginDataset[i],s=0;s<n.length;s++)r=this.tsfToVec(n[s]),this.classDataset[i].push(r);return[2]}})})},t}();__reflect(KNNClassifier.prototype,"KNNClassifier");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.onProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var KeyPoint=function(){function t(){}return t}();__reflect(KeyPoint.prototype,"KeyPoint");var DebugPlatform=function(){function t(){}return t.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,{nickName:"username"}]})})},t.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},t}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var PoseUtils=function(){function t(){this.loadModel()}return Object.defineProperty(t,"instance",{get:function(){return null==t._instance&&(t._instance=new t),t._instance},enumerable:!0,configurable:!0}),t.prototype.loadModel=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this,[4,posenet.load(.75)];case 1:return t.model=e.sent(),[2]}})})},t.prototype.estimateSinglePose=function(t,e,i,n){return void 0===e&&(e=.5),void 0===i&&(i=!1),void 0===n&&(n=16),__awaiter(this,void 0,void 0,function(){return __generator(this,function(s){switch(s.label){case 0:return[4,this.model.estimateSinglePose(t,e,i,n)];case 1:return[2,s.sent()]}})})},t}();__reflect(PoseUtils.prototype,"PoseUtils");var ShockUtils=function(){function t(){this.MAP=0,this.SPRITE=1,this.mapPoss=[new egret.Point(0,3),new egret.Point(3,2),new egret.Point(-3,-2)],this.spritePoss=[new egret.Point(5,0),new egret.Point(-5,0),new egret.Point(5,0)],this._shockLength=0,this._shockCount=0,this._rx=0,this._ry=0,this._type=0,this._repeatCount=0}return Object.defineProperty(t,"instance",{get:function(){return null==t._instance&&(t._instance=new t),t._instance},enumerable:!0,configurable:!0}),t.prototype.destroy=function(){this.stop(),this.target=null},t.prototype.shock=function(t){void 0===t&&(t=0),this._type=t,this._type==this.MAP?(this._shockPoss=this.mapPoss.concat(),this._shockLength=this._shockPoss.length):this._type==this.SPRITE&&(this._shockPoss=this.spritePoss.concat(),this._shockLength=this._shockPoss.length)},t.prototype.start=function(t){void 0===t&&(t=1),this.stop(),this.repeatCount=t,this._shockCount=0,this.target&&(this._rx=this.target.x,this._ry=this.target.y,TimerManager.instance.doFrameLoop(3,this.onShockEnter,this))},t.prototype.stop=function(){this.target&&(this.target.x=this._rx,this.target.y=this._ry,TimerManager.instance.clearTimerByFun(this.onShockEnter))},t.prototype.onShockEnter=function(t){var e=this._shockLength*this._repeatCount;if(this._shockCount>=e)return void this.stop();var i=this._shockCount%this._shockLength,n=this._shockPoss[i];this.target&&(this.target.x=this._rx+n.x,this.target.y=this._ry+n.y),this._shockCount++},Object.defineProperty(t.prototype,"repeatCount",{get:function(){return this._repeatCount},set:function(t){this._repeatCount=t},enumerable:!0,configurable:!0}),t}();__reflect(ShockUtils.prototype,"ShockUtils");var ThemeAdapter=function(){function t(){}return t.prototype.getTheme=function(t,e,i,n){function s(t){e.call(n,t)}function r(e){e.resItem.url==t&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,r,null),i.call(n))}var a=this;"undefined"!=typeof generateEUI?egret.callLater(function(){e.call(n,generateEUI)},this):"undefined"!=typeof generateEUI2?RES.getResByUrl("resource/gameEui.json",function(t,i){window.JSONParseClass.setData(t),egret.callLater(function(){e.call(n,generateEUI2)},a)},this,RES.ResourceItem.TYPE_JSON):(RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,r,null),RES.getResByUrl(t,s,this,RES.ResourceItem.TYPE_TEXT))},t}();__reflect(ThemeAdapter.prototype,"ThemeAdapter",["eui.IThemeAdapter"]);var TimerManager=function(){function t(){this._shape=new egret.Shape,this._pool=new Array,this._handlers=new Object,this._currTimer=egret.getTimer(),this._currFrame=0,this._count=0,this._index=0,this._shape.addEventListener(egret.Event.ENTER_FRAME,this.onEnterFrame,this)}return t.prototype.onEnterFrame=function(t){this._currFrame++,this._currTimer=egret.getTimer();var e;for(e in this._handlers)if("undefined"!=e){var i=this._handlers[e],n=i.userFrame?this._currFrame:this._currTimer,s=i.target;if(n>=i.exeTime){var r=i.method,a=i.args;if(i.repeat)if(1==i.multiTick)for(;n>=i.exeTime&&e in this._handlers;)i.exeTime+=i.delay,r.apply(s,a);else i.exeTime=n+i.delay,r.apply(s,a);else this.clearTimer(e),r.apply(s,a)}}},t.prototype.create=function(t,e,i,n,s,r,a,o){void 0===s&&(s=null),void 0===r&&(r=null),void 0===a&&(a=!1),void 0===o&&(o=!1);var h;if(a?(this.clearTimer(n),h=n):h=this._index++,1>i)return n.apply(null,r),-1;var c=this._pool.length>0?this._pool.pop():new TimerHandler;return c.userFrame=t,c.repeat=e,c.delay=i,c.method=n,c.args=r,c.target=s,c.exeTime=i+(t?this._currFrame:this._currTimer),c.multiTick=o,this._handlers[h]=c,this._count++,h},t.prototype.doOnce=function(t,e,i,n,s){return void 0===i&&(i=null),void 0===n&&(n=null),void 0===s&&(s=!1),this.create(!1,!1,t,e,i,n,s)},t.prototype.doLoop=function(t,e,i,n,s,r){return void 0===i&&(i=null),void 0===n&&(n=null),void 0===s&&(s=!0),void 0===r&&(r=!1),this.create(!1,!0,t,e,i,n,s,r)},t.prototype.doFrameOnce=function(t,e,i,n,s){return void 0===i&&(i=null),void 0===n&&(n=null),void 0===s&&(s=!1),this.create(!0,!1,t,e,i,n,s)},t.prototype.doFrameLoop=function(t,e,i,n,s){return void 0===i&&(i=null),void 0===n&&(n=null),void 0===s&&(s=!1),this.create(!0,!0,t,e,i,n,s)},Object.defineProperty(t.prototype,"count",{get:function(){return this._count},enumerable:!0,configurable:!0}),t.prototype.clearTimer=function(t){var e=this._handlers[t];null!=e&&(delete this._handlers[t],e.clear(),this._pool.push(e),this._count--)},t.prototype.destroy=function(){null!=this&&null!=this._shape&&this._shape.removeEventListener(egret.Event.ENTER_FRAME,this.onEnterFrame,this),t._instance=null},t.prototype.running=function(t){return null!=this._handlers[t]?!0:!1},t.prototype.clearTimerByFun=function(t){this.clearTimer(t)},Object.defineProperty(t,"instance",{get:function(){return null==t._instance&&(t._instance=new t),t._instance},enumerable:!0,configurable:!0}),t}();__reflect(TimerManager.prototype,"TimerManager");var TimerHandler=function(){function t(){this.delay=0,this.exeTime=0,this.target=null,this.multiTick=!1}return t.prototype.clear=function(){var t=this;t.delay=0,t.method=null,t.args=null,t.target=null,t.multiTick=!1},t}();__reflect(TimerHandler.prototype,"TimerHandler");